<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HA Button Card WYSIWYG v0.0.2.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fallback styles in case Tailwind doesn't load */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 0 0 20px 0;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .main-title {
            font-size: 2rem;
            font-weight: bold;
            color: #FFFFFF;
            text-align: center;
            background-color: #1abcf2;
            padding: 20px 0 0 0;
        }

        .version-number {
            font-size: 1rem;
            font-weight: regular;
            color: #FFFFFF;
            text-align: center;
            margin-bottom: 2rem;
            background-color: #1abcf2;
            padding: 0 0 20px 0;
        }
        
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .layout-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
        }
        
        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title-text {
            flex: 1;
        }
        
        .section {
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f3f4f6;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #374151;
            transition: background-color 0.2s;
        }
        
        .section-header:hover {
            background: #e5e7eb;
        }
        
        .section-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        .section-content.open {
            max-height: 1000px;
            padding: 16px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .form-grid-full {
            grid-column: 1 / -1;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .color-input {
            height: 40px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .preview-container {
            background: #f3f4f6;
            padding: 32px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
        }
        
        .card-preview {
            display: grid;
            grid-template-areas: 'i n' 'i s';
            grid-template-rows: 1fr 1fr;
            grid-template-columns: auto 1fr;
            gap: 0 10px;
            font-family: 'Roboto Condensed', sans-serif;
            background-color: #ffffff;
            padding: 0 0 0 6px;
            border: 1px solid #e5e7eb;
            border-radius: 100px;
            min-height: 64px;
            align-items: center;
            width: 100%;
            min-width: 200px;
            max-width: 400px;
            transition: all 0.3s ease;
        }
        
        .icon-area {
            grid-area: i;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            color: #0891b2;
            background-color: #f8fafc;
            border-radius: 50px;
            padding: 12px;
        }
        
        .name-area {
            grid-area: n;
            color: #64748b;
            font-size: 14px;
            font-weight: 800;
            justify-self: start;
            align-self: center;
            margin-bottom: -6px;
        }
        
        .state-area {
            grid-area: s;
            color: #cbd5e1;
            font-size: 12px;
            justify-self: start;
            align-self: center;
            margin-top: -6px;
        }
        
        .triangle-icon {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 17px solid currentColor;
            display: inline-block;
        }
        
        .yaml-container {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.6;
            overflow: auto;
            max-height: 400px;
        }
        
        .copy-button {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .copy-button:hover {
            background: #2563eb;
        }
        
        .copy-button.copied {
            background: #10b981;
        }

        .themes-button {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 12px;
        }
        
        .themes-button:hover {
            background: #059669;
        }
        
        .yaml-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .arrow {
            transition: transform 0.2s;
        }
        
        .arrow.rotated {
            transform: rotate(-90deg);
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 800px;
            width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 16px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
        }

        .modal-close:hover {
            color: #374151;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .theme-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .theme-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .theme-name {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            text-align: center;
        }

        .theme-preview {
            display: grid;
            grid-template-areas: 'i n' 'i s';
            grid-template-rows: 1fr 1fr;
            grid-template-columns: auto 1fr;
            gap: 0 8px;
            font-family: 'Roboto Condensed', sans-serif;
            padding: 0 0 0 4px;
            border-radius: 50px;
            min-height: 48px;
            align-items: center;
            font-size: 11px;
            margin: 0 auto;
            max-width: 160px;
        }

        .theme-preview .icon-area {
            width: 36px;
            height: 36px;
            border-radius: 50px;
            padding: 8px;
            font-size: 10px;
        }

        .theme-preview .name-area {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: -4px;
        }

        .theme-preview .state-area {
            font-size: 9px;
            margin-top: -4px;
        }

        /* State-based styling CSS */
        .state-condition {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .state-condition-header {
            background: #f9fafb;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #374151;
            transition: background-color 0.2s;
        }

        .state-condition-header:hover {
            background: #f3f4f6;
        }

        .state-condition-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .state-condition-content.open {
            max-height: 2000px;
            padding: 16px;
        }

        .add-state-button {
            background: #10b981;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 16px;
        }

        .add-state-button:hover {
            background: #059669;
        }

        .delete-state-button {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 8px;
        }

        .delete-state-button:hover {
            background: #dc2626;
        }

        .copy-styles-button {
            background: #6366f1;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 12px;
        }

        .copy-styles-button:hover {
            background: #4f46e5;
        }

        .state-selector {
            margin-bottom: 20px;
            padding: 12px;
            background: #e0f2fe;
            border-radius: 8px;
            border: 1px solid #0891b2;
        }

        .state-selector-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #0891b2;
            margin-bottom: 8px;
        }

        .section-controls {
            display: flex;
            gap: 12px;
        }

        .section-control-link {
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.875rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .section-control-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .section-control-link.disabled {
            color: #9ca3af;
            cursor: not-allowed;
            text-decoration: none;
        }

        .section-control-link.disabled:hover {
            color: #9ca3af;
            text-decoration: none;
        }
    </style>
</head>
<body>
<h1 class="main-title">HA Button Card WYSIWYG</h1>
<div class="version-number">Version v0.0.2.3-a2</div>
    
    <div class="container">
        
        <div class="layout-grid">
            <!-- Left Panel - WYSIWYG Editor -->
            <div class="panel">
                <h2 class="panel-title">
                    <span class="panel-title-text">Card Settings</span>
                    <div class="section-controls">
                        <span class="section-control-link" id="expandAllLink" onclick="expandAllSections()">Expand All</span>
                        <span class="section-control-link" id="collapseAllLink" onclick="collapseAllSections()">Collapse All</span>
                    </div>
                </h2>

                <!-- Content Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('content')">
                        <span>Entity & Content</span>
                        <span class="arrow" id="content-arrow">▼</span>
                    </div>
                    <div class="section-content" id="content-content">
                        <div class="form-grid">
                            <div class="form-group form-grid-full">
                                <label class="form-label">Entity</label>
                                <input type="text" id="entity" value="sensor.helper_count_lights_on_interior" class="form-input">
                            </div>
                            <div class="form-group form-grid-full">
                                <label class="form-label">Name</label>
                                <input type="text" id="cardName" value="Lights On (Inside)" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Show Name</label>
                                <select id="showName" class="form-input">
                                    <option value="true" selected>True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Show Icon</label>
                                <select id="showIcon" class="form-input">
                                    <option value="true" selected>True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Show State</label>
                                <select id="showState" class="form-input">
                                    <option value="true" selected>True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Card Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('card')">
                        <span>Card</span>
                        <span class="arrow" id="card-arrow">▼</span>
                    </div>
                    <div class="section-content" id="card-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <input type="color" id="cardBackground" value="#ffffff" class="color-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border Color</label>
                                <input type="color" id="cardBorderColor" value="#e5e7eb" class="color-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border Width</label>
                                <input type="number" id="cardBorderWidth" value="1" min="0" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border Radius</label>
                                <input type="number" id="cardBorderRadius" value="100" min="0" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Padding</label>
                                <input type="text" id="cardPadding" value="0 0 0 6px" placeholder="top right bottom left" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Min Height (px)</label>
                                <input type="number" id="cardMinHeight" value="64" min="0" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Icon Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('icon')">
                        <span>Icon</span>
                        <span class="arrow" id="icon-arrow">▼</span>
                    </div>
                    <div class="section-content" id="icon-content">
                        <div class="form-grid">
                            <div class="form-group form-grid-full">
                                <label class="form-label">Icon Name</label>
                                <input type="text" id="iconName" value="mdi:lightbulb-on" placeholder="mdi:icon-name" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Icon Color</label>
                                <input type="color" id="iconColor" value="#0891b2" class="color-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Icon Size (px)</label>
                                <input type="number" id="iconSize" value="28" min="0" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <input type="color" id="iconBackground" value="#f8fafc" class="color-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Background Radius (px)</label>
                                <input type="number" id="iconBackgroundRadius" value="50" min="0" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Padding (px)</label>
                                <input type="number" id="iconPadding" value="12" min="0" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typography Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('typography')">
                        <span>Typography</span>
                        <span class="arrow" id="typography-arrow">▼</span>
                    </div>
                    <div class="section-content" id="typography-content">
                        <div class="form-grid">
                            <div class="form-group form-grid-full">
                                <label class="form-label">Font Family</label>
                                <input type="text" id="fontFamily" value="Roboto Condensed" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name Font Size (px)</label>
                                <input type="number" id="nameFontSize" value="14" min="0" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name Font Weight</label>
                                <select id="nameFontWeight" class="form-input">
                                    <option value="400">Normal</option>
                                    <option value="600">Semi Bold</option>
                                    <option value="700">Bold</option>
                                    <option value="800" selected>Extra Bold</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name Color</label>
                                <input type="color" id="nameColor" value="#64748b" class="color-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">State Font Size (px)</label>
                                <input type="number" id="stateFontSize" value="12" min="0" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">State Color</label>
                                <input type="color" id="stateColor" value="#cbd5e1" class="color-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Layout Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('layout')">
                        <span>Layout</span>
                        <span class="arrow" id="layout-arrow">▼</span>
                    </div>
                    <div class="section-content" id="layout-content">
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <div class="form-group">
                                <label class="form-label">Grid Template Areas</label>
                                <input type="text" id="gridAreas" value="i n, i s" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grid Template Rows</label>
                                <input type="text" id="gridRows" value="1fr 1fr" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Grid Template Columns</label>
                                <input type="text" id="gridColumns" value="auto 1fr" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gap</label>
                                <input type="text" id="gridGap" value="0 10px" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- State-Based Styles Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection('stateStyles')">
                        <span>State-Based Styles</span>
                        <span class="arrow" id="stateStyles-arrow">▼</span>
                    </div>
                    <div class="section-content" id="stateStyles-content">
                        <button class="add-state-button" onclick="addStateCondition()">+ Add State Condition</button>
                        <div id="stateConditions"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Card Preview -->
                <div class="panel">
                    <h2 class="panel-title">
                        <span>Preview</span>
                        <button onclick="openThemesModal()" class="themes-button">Themes</button>
                    </h2>
                    
                    <div class="preview-container">
                        <div id="cardPreview" class="card-preview">
                            <div class="icon-area">
                                <div class="triangle-icon"></div>
                            </div>
                            <div class="name-area">Lights On (Inside)</div>
                            <div class="state-area">5</div>
                        </div>
                    </div>
                </div>

                <!-- State Selector -->
                <div class="state-selector">
                    <div class="state-selector-label">Mock Entity State (for preview)</div>
                    <select id="mockEntityState" class="form-input" onchange="updatePreview()">
                        <option value="on">on</option>
                        <option value="off">off</option>
                        <option value="unavailable">unavailable</option>
                    </select>
                </div>

                <!-- YAML Output -->
                <div class="panel">
                    <div class="yaml-header">
                        <h2 class="panel-title" style="margin-bottom: 0;">YAML Code</h2>
                        <button onclick="copyYaml()" class="copy-button">Copy to Clipboard</button>
                    </div>
                    <div class="yaml-container">
                        <pre id="yamlOutput"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Themes Modal -->
    <div id="themesModal" class="modal-overlay" onclick="closeThemesModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Choose a Theme</h3>
                <button class="modal-close" onclick="closeThemesModal()">&times;</button>
            </div>
            <div class="themes-grid" id="themesGrid">
                <!-- Themes will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global variables for state-based styling
        let stateConditions = [];
        let stateConditionCounter = 0;

        // Main sections for expand/collapse functionality
        const mainSections = ['card', 'icon', 'typography', 'layout', 'content', 'stateStyles'];

        // Theme definitions
        const themes = {
            modernDark: {
                name: 'Modern Dark',
                settings: {
                    cardBackground: '#1f2937',
                    cardBorderColor: '#374151',
                    cardBorderWidth: '2',
                    cardBorderRadius: '16',
                    cardPadding: '0 0 0 8px',
                    cardMinHeight: '72',
                    iconColor: '#60a5fa',
                    iconBackground: '#374151',
                    iconBackgroundRadius: '12',
                    iconPadding: '14',
                    iconSize: '24',
                    fontFamily: 'Inter',
                    nameFontSize: '15',
                    nameFontWeight: '600',
                    nameColor: '#f9fafb',
                    stateFontSize: '13',
                    stateColor: '#9ca3af'
                }
            },
            classicLight: {
                name: 'Classic Light',
                settings: {
                    cardBackground: '#ffffff',
                    cardBorderColor: '#d1d5db',
                    cardBorderWidth: '1',
                    cardBorderRadius: '8',
                    cardPadding: '12px 16px',
                    cardMinHeight: '80',
                    iconColor: '#059669',
                    iconBackground: '#ecfdf5',
                    iconBackgroundRadius: '6',
                    iconPadding: '12',
                    iconSize: '20',
                    fontFamily: 'Georgia',
                    nameFontSize: '16',
                    nameFontWeight: '700',
                    nameColor: '#111827',
                    stateFontSize: '14',
                    stateColor: '#6b7280'
                }
            },
            vibrant: {
                name: 'Vibrant',
                settings: {
                    cardBackground: '#fef3c7',
                    cardBorderColor: '#f59e0b',
                    cardBorderWidth: '3',
                    cardBorderRadius: '24',
                    cardPadding: '0 0 0 8px',
                    cardMinHeight: '68',
                    iconColor: '#dc2626',
                    iconBackground: '#fef2f2',
                    iconBackgroundRadius: '50',
                    iconPadding: '16',
                    iconSize: '28',
                    fontFamily: 'Arial Black',
                    nameFontSize: '16',
                    nameFontWeight: '800',
                    nameColor: '#7c2d12',
                    stateFontSize: '14',
                    stateColor: '#ea580c'
                }
            },
            minimal: {
                name: 'Minimal',
                settings: {
                    cardBackground: '#fafafa',
                    cardBorderColor: '#f5f5f5',
                    cardBorderWidth: '0',
                    cardBorderRadius: '0',
                    cardPadding: '16px 20px',
                    cardMinHeight: '60',
                    iconColor: '#525252',
                    iconBackground: 'transparent',
                    iconBackgroundRadius: '0',
                    iconPadding: '0',
                    iconSize: '18',
                    fontFamily: 'Helvetica Neue',
                    nameFontSize: '14',
                    nameFontWeight: '400',
                    nameColor: '#171717',
                    stateFontSize: '12',
                    stateColor: '#a3a3a3'
                }
            },
            retro: {
                name: 'Retro',
                settings: {
                    cardBackground: '#fed7aa',
                    cardBorderColor: '#ea580c',
                    cardBorderWidth: '2',
                    cardBorderRadius: '20',
                    cardPadding: '0 0 0 6px',
                    cardMinHeight: '70',
                    iconColor: '#92400e',
                    iconBackground: '#fbbf24',
                    iconBackgroundRadius: '50',
                    iconPadding: '12',
                    iconSize: '24',
                    fontFamily: 'Courier New',
                    nameFontSize: '14',
                    nameFontWeight: '700',
                    nameColor: '#78350f',
                    stateFontSize: '12',
                    stateColor: '#a16207'
                }
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load section states from localStorage
            loadSectionStates();
            
            // Add event listeners to all inputs
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    updatePreview();
                    updateYaml();
                });
            });
            
            // Initialize display
            updatePreview();
            updateYaml();
            updateSectionControls();
            populateThemes();
        });

        function populateThemes() {
            const grid = document.getElementById('themesGrid');
            grid.innerHTML = '';

            Object.keys(themes).forEach(themeKey => {
                const theme = themes[themeKey];
                const themeCard = document.createElement('div');
                themeCard.className = 'theme-card';
                themeCard.onclick = () => applyTheme(themeKey);

                // Create preview based on theme settings
                const preview = createThemePreview(theme.settings);
                
                themeCard.innerHTML = `
                    <div class="theme-name">${theme.name}</div>
                    ${preview}
                `;

                grid.appendChild(themeCard);
            });
        }

        function createThemePreview(settings) {
            return `
                <div class="theme-preview" style="
                    background-color: ${settings.cardBackground}; 
                    border: ${settings.cardBorderWidth}px solid ${settings.cardBorderColor}; 
                    border-radius: ${settings.cardBorderRadius}px;
                    padding: ${settings.cardPadding};
                    min-height: ${Math.max(48, settings.cardMinHeight * 0.7)}px;
                    font-family: ${settings.fontFamily};
                ">
                    <div class="icon-area" style="
                        color: ${settings.iconColor}; 
                        background-color: ${settings.iconBackground}; 
                        border-radius: ${settings.iconBackgroundRadius}px;
                        padding: ${Math.max(8, settings.iconPadding * 0.7)}px;
                    ">
                        <div class="triangle-icon" style="
                            border-left-width: ${Math.max(6, settings.iconSize * 0.3)}px;
                            border-right-width: ${Math.max(6, settings.iconSize * 0.3)}px;
                            border-bottom-width: ${Math.max(10, settings.iconSize * 0.5)}px;
                        "></div>
                    </div>
                    <div class="name-area" style="
                        color: ${settings.nameColor}; 
                        font-size: ${Math.max(10, settings.nameFontSize * 0.8)}px; 
                        font-weight: ${settings.nameFontWeight};
                    ">Sample Card</div>
                    <div class="state-area" style="
                        color: ${settings.stateColor}; 
                        font-size: ${Math.max(8, settings.stateFontSize * 0.8)}px;
                    ">On</div>
                </div>
            `;
        }

        function openThemesModal() {
            const modal = document.getElementById('themesModal');
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeThemesModal(event) {
            if (event && event.target !== event.currentTarget && !event.currentTarget.contains(event.target)) {
                return;
            }
            
            const modal = document.getElementById('themesModal');
            modal.classList.remove('open');
            document.body.style.overflow = '';
        }

        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            const settings = theme.settings;

            // Apply theme settings to form inputs (preserving content settings)
            Object.keys(settings).forEach(settingKey => {
                const element = document.getElementById(settingKey);
                if (element) {
                    element.value = settings[settingKey];
                }
            });

            // Update preview and YAML
            updatePreview();
            updateYaml();

            // Close modal
            closeThemesModal();
        }

        function loadSectionStates() {
            const savedStates = localStorage.getItem('ha-button-card-editor-sections');
            if (savedStates) {
                try {
                    const states = JSON.parse(savedStates);
                    mainSections.forEach(sectionId => {
                        const isOpen = states[sectionId] || false;
                        const content = document.getElementById(sectionId + '-content');
                        const arrow = document.getElementById(sectionId + '-arrow');
                        
                        if (isOpen) {
                            content.classList.add('open');
                            arrow.textContent = '▼';
                            arrow.classList.remove('rotated');
                        } else {
                            content.classList.remove('open');
                            arrow.textContent = '▶';
                            arrow.classList.add('rotated');
                        }
                    });
                } catch (error) {
                    console.log('Error loading section states:', error);
                    // If there's an error, all sections will remain collapsed (default state)
                }
            }
        }

        function saveSectionStates() {
            const states = {};
            mainSections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                states[sectionId] = content.classList.contains('open');
            });
            localStorage.setItem('ha-button-card-editor-sections', JSON.stringify(states));
        }

        function updateSectionControls() {
            const expandAllLink = document.getElementById('expandAllLink');
            const collapseAllLink = document.getElementById('collapseAllLink');
            
            const openSections = mainSections.filter(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                return content.classList.contains('open');
            });
            
            // Update Expand All button
            if (openSections.length === mainSections.length) {
                expandAllLink.classList.add('disabled');
            } else {
                expandAllLink.classList.remove('disabled');
            }
            
            // Update Collapse All button
            if (openSections.length === 0) {
                collapseAllLink.classList.add('disabled');
            } else {
                collapseAllLink.classList.remove('disabled');
            }
        }

        function expandAllSections() {
            const expandAllLink = document.getElementById('expandAllLink');
            if (expandAllLink.classList.contains('disabled')) return;
            
            mainSections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                const arrow = document.getElementById(sectionId + '-arrow');
                
                content.classList.add('open');
                arrow.textContent = '▼';
                arrow.classList.remove('rotated');
            });
            
            saveSectionStates();
            updateSectionControls();
        }

        function collapseAllSections() {
            const collapseAllLink = document.getElementById('collapseAllLink');
            if (collapseAllLink.classList.contains('disabled')) return;
            
            mainSections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                const arrow = document.getElementById(sectionId + '-arrow');
                
                content.classList.remove('open');
                arrow.textContent = '▶';
                arrow.classList.add('rotated');
            });
            
            saveSectionStates();
            updateSectionControls();
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const arrow = document.getElementById(sectionId + '-arrow');
            
            content.classList.toggle('open');
            
            if (content.classList.contains('open')) {
                arrow.textContent = '▼';
                arrow.classList.remove('rotated');
            } else {
                arrow.textContent = '▶';
                arrow.classList.add('rotated');
            }
            
            // Save state and update controls
            saveSectionStates();
            updateSectionControls();
        }

        function toggleStateCondition(conditionId) {
            const content = document.getElementById(`stateCondition-${conditionId}-content`);
            const arrow = document.getElementById(`stateCondition-${conditionId}-arrow`);
            
            content.classList.toggle('open');
            
            if (content.classList.contains('open')) {
                arrow.textContent = '▼';
                arrow.classList.remove('rotated');
            } else {
                arrow.textContent = '▶';
                arrow.classList.add('rotated');
            }
        }

        function addStateCondition() {
            const conditionId = stateConditionCounter++;
            const condition = {
                id: conditionId,
                value: 'on',
                styles: {}
            };
            
            stateConditions.push(condition);
            renderStateConditions();
            updateYaml();
        }

        function deleteStateCondition(conditionId) {
            stateConditions = stateConditions.filter(condition => condition.id !== conditionId);
            renderStateConditions();
            updatePreview();
            updateYaml();
        }

        function copyBaseStyles(conditionId) {
            const condition = stateConditions.find(c => c.id === conditionId);
            if (!condition) return;

            // Copy all current base styles
            condition.styles = {
                card: {
                    backgroundColor: document.getElementById('cardBackground').value,
                    borderColor: document.getElementById('cardBorderColor').value,
                    borderWidth: document.getElementById('cardBorderWidth').value + 'px',
                    borderRadius: document.getElementById('cardBorderRadius').value + 'px',
                    padding: document.getElementById('cardPadding').value,
                    minHeight: document.getElementById('cardMinHeight').value + 'px',
                    fontFamily: document.getElementById('fontFamily').value,
                    fontSize: document.getElementById('nameFontSize').value + 'px'
                },
                icon: {
                    color: document.getElementById('iconColor').value,
                    backgroundColor: document.getElementById('iconBackground').value,
                    borderRadius: document.getElementById('iconBackgroundRadius').value + 'px',
                    padding: document.getElementById('iconPadding').value + 'px',
                    width: document.getElementById('iconSize').value + 'px'
                },
                name: {
                    color: document.getElementById('nameColor').value,
                    fontSize: document.getElementById('nameFontSize').value + 'px',
                    fontWeight: document.getElementById('nameFontWeight').value
                },
                state: {
                    color: document.getElementById('stateColor').value,
                    fontSize: document.getElementById('stateFontSize').value + 'px'
                }
            };

            renderStateConditions();
            updatePreview();
            updateYaml();
        }

        function renderStateConditions() {
            const container = document.getElementById('stateConditions');
            container.innerHTML = '';

            stateConditions.forEach(condition => {
                const conditionHtml = `
                    <div class="state-condition">
                        <div class="state-condition-header" onclick="toggleStateCondition(${condition.id})">
                            <span>State: ${condition.value}</span>
                            <div>
                                <button class="delete-state-button" onclick="event.stopPropagation(); deleteStateCondition(${condition.id})">Delete</button>
                                <span class="arrow" id="stateCondition-${condition.id}-arrow">▼</span>
                            </div>
                        </div>
                        <div class="state-condition-content open" id="stateCondition-${condition.id}-content">
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label">State Value</label>
                                <select oninput="updateStateValue(${condition.id}, this.value)" class="form-input">
                                    <option value="on" ${condition.value === 'on' ? 'selected' : ''}>on</option>
                                    <option value="off" ${condition.value === 'off' ? 'selected' : ''}>off</option>
                                    <option value="unavailable" ${condition.value === 'unavailable' ? 'selected' : ''}>unavailable</option>
                                </select>
                            </div>
                            
                            <button class="copy-styles-button" onclick="copyBaseStyles(${condition.id})">Copy Current Base Styles</button>
                            
                            ${renderStateStyleSections(condition)}
                        </div>
                    </div>
                `;
                container.innerHTML += conditionHtml;
            });
        }

        function renderStateStyleSections(condition) {
            return `
                <!-- Card Styles -->
                <div style="margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px; font-weight: 600;">Card Styles</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Background Color</label>
                            <input type="color" value="${condition.styles.card?.backgroundColor || '#ffffff'}" 
                                   oninput="updateStateStyle(${condition.id}, 'card', 'backgroundColor', this.value)" class="color-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Border Color</label>
                            <input type="color" value="${condition.styles.card?.borderColor || '#e5e7eb'}" 
                                   oninput="updateStateStyle(${condition.id}, 'card', 'borderColor', this.value)" class="color-input">
                        </div>
                    </div>
                </div>

                <!-- Icon Styles -->
                <div style="margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px; font-weight: 600;">Icon Styles</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Icon Color</label>
                            <input type="color" value="${condition.styles.icon?.color || '#0891b2'}" 
                                   oninput="updateStateStyle(${condition.id}, 'icon', 'color', this.value)" class="color-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Background Color</label>
                            <input type="color" value="${condition.styles.icon?.backgroundColor || '#f8fafc'}" 
                                   oninput="updateStateStyle(${condition.id}, 'icon', 'backgroundColor', this.value)" class="color-input">
                        </div>
                    </div>
                </div>

                <!-- Name Styles -->
                <div style="margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px; font-weight: 600;">Name Styles</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Name Color</label>
                            <input type="color" value="${condition.styles.name?.color || '#64748b'}" 
                                   oninput="updateStateStyle(${condition.id}, 'name', 'color', this.value)" class="color-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Font Weight</label>
                            <select oninput="updateStateStyle(${condition.id}, 'name', 'fontWeight', this.value)" class="form-input">
                                <option value="400" ${condition.styles.name?.fontWeight === '400' ? 'selected' : ''}>Normal</option>
                                <option value="600" ${condition.styles.name?.fontWeight === '600' ? 'selected' : ''}>Semi Bold</option>
                                <option value="700" ${condition.styles.name?.fontWeight === '700' ? 'selected' : ''}>Bold</option>
                                <option value="800" ${condition.styles.name?.fontWeight === '800' ? 'selected' : ''}>Extra Bold</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- State Styles -->
                <div style="margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px; font-weight: 600;">State Styles</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">State Color</label>
                            <input type="color" value="${condition.styles.state?.color || '#cbd5e1'}" 
                                   oninput="updateStateStyle(${condition.id}, 'state', 'color', this.value)" class="color-input">
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStateValue(conditionId, value) {
            const condition = stateConditions.find(c => c.id === conditionId);
            if (condition) {
                condition.value = value;
                renderStateConditions();
                updatePreview();
                updateYaml();
            }
        }

        function updateStateStyle(conditionId, section, property, value) {
            const condition = stateConditions.find(c => c.id === conditionId);
            if (condition) {
                if (!condition.styles[section]) {
                    condition.styles[section] = {};
                }
                condition.styles[section][property] = value;
                updatePreview();
                updateYaml();
            }
        }

        function updatePreview() {
            const preview = document.getElementById('cardPreview');
            const iconArea = preview.querySelector('.icon-area');
            const nameArea = preview.querySelector('.name-area');
            const stateArea = preview.querySelector('.state-area');
            const mockState = document.getElementById('mockEntityState').value;

            // Find active state condition
            const activeCondition = stateConditions.find(condition => condition.value === mockState);

            // Apply base styles first
            applyBaseStyles(preview, iconArea, nameArea, stateArea);

            // Apply state-specific styles if condition exists
            if (activeCondition && activeCondition.styles) {
                applyStateStyles(preview, iconArea, nameArea, stateArea, activeCondition.styles);
            }

            // Update state display text
            const stateDisplayMap = {
                'on': 'On',
                'off': 'Off',
                'unavailable': 'Unavailable'
            };
            stateArea.textContent = stateDisplayMap[mockState] || mockState;

            // Content
            nameArea.textContent = document.getElementById('cardName').value;
            
            // Show/hide elements
            iconArea.style.display = document.getElementById('showIcon').value === 'true' ? 'flex' : 'none';
            nameArea.style.display = document.getElementById('showName').value === 'true' ? 'block' : 'none';
            stateArea.style.display = document.getElementById('showState').value === 'true' ? 'block' : 'none';
        }

        function applyBaseStyles(preview, iconArea, nameArea, stateArea) {
            // Card styles
            preview.style.backgroundColor = document.getElementById('cardBackground').value;
            preview.style.borderColor = document.getElementById('cardBorderColor').value;
            preview.style.borderWidth = document.getElementById('cardBorderWidth').value + 'px';
            preview.style.borderRadius = document.getElementById('cardBorderRadius').value + 'px';
            preview.style.padding = document.getElementById('cardPadding').value;
            preview.style.minHeight = document.getElementById('cardMinHeight').value + 'px';

            // Grid layout
            preview.style.gridTemplateAreas = document.getElementById('gridAreas').value;
            preview.style.gridTemplateRows = document.getElementById('gridRows').value;
            preview.style.gridTemplateColumns = document.getElementById('gridColumns').value;
            preview.style.gap = document.getElementById('gridGap').value;

            // Icon styles
            iconArea.style.color = document.getElementById('iconColor').value;
            iconArea.style.backgroundColor = document.getElementById('iconBackground').value;
            iconArea.style.borderRadius = document.getElementById('iconBackgroundRadius').value + 'px';
            iconArea.style.padding = document.getElementById('iconPadding').value + 'px';
            
            const iconSize = document.getElementById('iconSize').value;
            iconArea.style.width = (parseInt(iconSize) + parseInt(document.getElementById('iconPadding').value) * 2) + 'px';
            iconArea.style.height = (parseInt(iconSize) + parseInt(document.getElementById('iconPadding').value) * 2) + 'px';

            // Typography
            const fontFamily = document.getElementById('fontFamily').value;
            preview.style.fontFamily = fontFamily;
            
            nameArea.style.color = document.getElementById('nameColor').value;
            nameArea.style.fontSize = document.getElementById('nameFontSize').value + 'px';
            nameArea.style.fontWeight = document.getElementById('nameFontWeight').value;
            
            stateArea.style.color = document.getElementById('stateColor').value;
            stateArea.style.fontSize = document.getElementById('stateFontSize').value + 'px';
        }

        function applyStateStyles(preview, iconArea, nameArea, stateArea, styles) {
            // Apply card styles
            if (styles.card) {
                if (styles.card.backgroundColor) preview.style.backgroundColor = styles.card.backgroundColor;
                if (styles.card.borderColor) preview.style.borderColor = styles.card.borderColor;
                if (styles.card.borderWidth) preview.style.borderWidth = styles.card.borderWidth;
                if (styles.card.borderRadius) preview.style.borderRadius = styles.card.borderRadius;
                if (styles.card.padding) preview.style.padding = styles.card.padding;
                if (styles.card.minHeight) preview.style.minHeight = styles.card.minHeight;
                if (styles.card.fontFamily) preview.style.fontFamily = styles.card.fontFamily;
            }

            // Apply icon styles
            if (styles.icon) {
                if (styles.icon.color) iconArea.style.color = styles.icon.color;
                if (styles.icon.backgroundColor) iconArea.style.backgroundColor = styles.icon.backgroundColor;
                if (styles.icon.borderRadius) iconArea.style.borderRadius = styles.icon.borderRadius;
                if (styles.icon.padding) iconArea.style.padding = styles.icon.padding;
                if (styles.icon.width) {
                    const width = parseInt(styles.icon.width);
                    const padding = parseInt(styles.icon.padding) || parseInt(document.getElementById('iconPadding').value);
                    iconArea.style.width = (width + padding * 2) + 'px';
                    iconArea.style.height = (width + padding * 2) + 'px';
                }
            }

            // Apply name styles
            if (styles.name) {
                if (styles.name.color) nameArea.style.color = styles.name.color;
                if (styles.name.fontSize) nameArea.style.fontSize = styles.name.fontSize;
                if (styles.name.fontWeight) nameArea.style.fontWeight = styles.name.fontWeight;
            }

            // Apply state styles
            if (styles.state) {
                if (styles.state.color) stateArea.style.color = styles.state.color;
                if (styles.state.fontSize) stateArea.style.fontSize = styles.state.fontSize;
            }
        }

        function updateYaml() {
            // Get the grid areas value and convert it to Home Assistant format
            let gridAreas = document.getElementById('gridAreas').value.trim();
            
            // Convert simple format "i n, i s" to Home Assistant format "\"i n\" \"i s\""
            if (gridAreas && !gridAreas.includes('\\"')) {
                // Split by comma and wrap each part in escaped quotes
                const areas = gridAreas.split(',').map(area => `\\"${area.trim()}\\"`).join(' ');
                gridAreas = `"${areas}"`;
            }
            
            // Function to format hex colors with single quotes
            function formatColor(color) {
                return `'${color}'`;
            }
            
            let yaml = `type: custom:button-card
entity: ${document.getElementById('entity').value}
layout: icon_state_name2nd
show_name: ${document.getElementById('showName').value}
show_icon: ${document.getElementById('showIcon').value}
icon: ${document.getElementById('iconName').value}
show_state: ${document.getElementById('showState').value}
name: ${document.getElementById('cardName').value}
styles:
  grid:
    - grid-template-areas: ${gridAreas}
    - grid-template-rows: ${document.getElementById('gridRows').value}
    - grid-template-columns: ${document.getElementById('gridColumns').value}
    - gap: ${document.getElementById('gridGap').value}
  card:
    - font-family: ${document.getElementById('fontFamily').value}
    - font-size: ${document.getElementById('nameFontSize').value}px
    - background-color: ${formatColor(document.getElementById('cardBackground').value)}
    - padding: ${document.getElementById('cardPadding').value}
    - border: ${document.getElementById('cardBorderWidth').value}px solid ${formatColor(document.getElementById('cardBorderColor').value)}
    - border-radius: ${document.getElementById('cardBorderRadius').value}px !important
    - box-shadow: none
    - min-height: ${document.getElementById('cardMinHeight').value}px !important
  icon:
    - width: ${document.getElementById('iconSize').value}px
    - height: auto
    - color: ${formatColor(document.getElementById('iconColor').value)}
    - background-color: ${formatColor(document.getElementById('iconBackground').value)}
    - border-radius: ${document.getElementById('iconBackgroundRadius').value}px
    - padding: ${document.getElementById('iconPadding').value}px
  name:
    - color: ${formatColor(document.getElementById('nameColor').value)}
    - font-size: ${document.getElementById('nameFontSize').value}px
    - font-weight: ${document.getElementById('nameFontWeight').value}
    - justify-self: start
    - align-self: center
    - margin-bottom: "-6px"
  state:
    - color: ${formatColor(document.getElementById('stateColor').value)}
    - font-size: ${document.getElementById('stateFontSize').value}px
    - justify-self: start
    - align-self: center
    - margin-top: "-6px"`;

            // Add state conditions if any exist
            if (stateConditions.length > 0) {
                yaml += '\nstate:';
                stateConditions.forEach(condition => {
                    yaml += `\n  - value: "${condition.value}"`;
                    if (condition.styles && Object.keys(condition.styles).length > 0) {
                        yaml += '\n    styles:';
                        
                        // Add card styles
                        if (condition.styles.card && Object.keys(condition.styles.card).length > 0) {
                            yaml += '\n      card:';
                            Object.entries(condition.styles.card).forEach(([key, value]) => {
                                const cssProperty = convertToCssProperty(key);
                                const formattedValue = key.includes('Color') ? formatColor(value) : value;
                                yaml += `\n        - ${cssProperty}: ${formattedValue}`;
                            });
                        }
                        
                        // Add icon styles
                        if (condition.styles.icon && Object.keys(condition.styles.icon).length > 0) {
                            yaml += '\n      icon:';
                            Object.entries(condition.styles.icon).forEach(([key, value]) => {
                                const cssProperty = convertToCssProperty(key);
                                const formattedValue = key.includes('Color') ? formatColor(value) : value;
                                yaml += `\n        - ${cssProperty}: ${formattedValue}`;
                            });
                        }
                        
                        // Add name styles
                        if (condition.styles.name && Object.keys(condition.styles.name).length > 0) {
                            yaml += '\n      name:
